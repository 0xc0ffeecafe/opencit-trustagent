<!DOCTYPE html>



<html lang="en">
    <!--
    HTML5 documentation:
    http://www.w3.org/html/wg/drafts/html/master/
    http://www.w3.org/TR/2010/WD-html5-20100624/
    http://dev.w3.org/html5/html-author/
    
    Documentation on properties of HTA:APPLICATION: 
    http://www.htmlgoodies.com/beyond/reference/article.php/3472841/HTML-Applications.htm
    http://msdn.microsoft.com/library/default.asp?url=/workshop/author/hta/overview/htaoverview.asp
    
    It's possible to pack all the resources into a single executable with a custom icon using WinRAR:
    http://stackoverflow.com/questions/4592410/is-it-possible-to-add-custom-icon-to-hta
    http://www.rarlab.com/shop2rarlab-index.php?prod=winrar&x-source=winraronly
    
    <h1>Credits</h1>
    <p>Javascript libraries <a href="http://prototypejs.org/" target="_blank">prototype.js</a> (<a href="http://prototypejs.org/license.html" target="_blank">MIT License</a>), <a href="http://script.aculo.us/" target="_blank">scriptaculous.js</a> (<a href="http://madrobby.github.io/scriptaculous/license/" target="_blank">MIT License</a>), <a href="http://livepipe.net/" target="_blank">livepipe.js</a> (<a href="http://livepipe.net/#MIT" target="_blank">MIT License</a>), and <a href="https://github.com/atetlaw/Really-Easy-Field-Validation" target="_blank">validation</a> (<a href="http://opensource.org/licenses/MIT" target="_blank">MIT License</a>).</p>
    http://ajaxload.info/  for the ajax loading icon. license: "generated gifs are totally free for use"
    
    -->
    <head>
        
        
        <title>Asset Tag Reference Implementation</title>
        <meta name="application-name" content="Mt Wilson Asset Tag Reference Implementation"/>
        <meta name="description" content="A web-based tool for defining tags and provisioning asset certificates" />
        <meta name="keywords" content="Mt Wilson, attestation, asset, inventory, management, security, cloud, data center" />
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />

        <!--
    <HTA:APPLICATION ID="oMyApp" 
        APPLICATIONNAME="Mystery Hill Demo" 
        BORDER="yes"
        BORDERSTYLE="normal"
        innerBorder="yes"
        navigable="yes"
        CAPTION="yes"
        SHOWINTASKBAR="yes"
        SINGLEINSTANCE="yes"
        maximizeButton="yes"
        minimizeButton="yes"
        SYSMENU="yes"
        SCROLL="auto"
        scrollFlat="no"
        ICON="intel-logo-blue-transparent-160x121.ico"
        WINDOWSTATE="maximize"/>
        -->
        <link rel="resources" type="application/vnd.mtwilson.resource+json" href="/resources.json">
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
        <!--
        <link rel="stylesheet" href="images/MarketPlace.css" type="text/css" />
        <link rel="stylesheet" href="morestyle.css" type="text/css" />
        -->
        <link rel="stylesheet" href="images/at.css" type="text/css" />
        <link rel="stylesheet" type="text/css" href="CSS/home.css" />
        <link rel="stylesheet" type="text/css" href="CSS/JQueryHelperCSS/jquery.ui.menubar.css" />
        <link rel="stylesheet" type="text/css" href="CSS/JQueryHelperCSS/style.css" />


        <!--		<script src="ie-settimeout.js" type="text/javascript"><script> -->
        <script src="watch.js" type="text/javascript"></script> <!-- required to use rivets -->
        <script src="prototype-1.7.1.js" type="text/javascript"></script> <!-- required by log.js -->
        <!-- ui tools -->
        <script src="scriptaculous-1.9.0/scriptaculous.js" type="text/javascript"></script> 
        <script src="livepipe/livepipe.js" type="text/javascript"></script>
        <script src="livepipe/contextmenu.js" type="text/javascript"></script>
        <script src="livepipe/cookie.js" type="text/javascript"></script>
        <script src="livepipe/event_behavior.js" type="text/javascript"></script>
        <script src="livepipe/hotkey.js" type="text/javascript"></script>
        <script src="livepipe/progressbar.js" type="text/javascript"></script>
        <script src="livepipe/rating.js" type="text/javascript"></script>
        <script src="livepipe/resizable.js" type="text/javascript"></script>
        <!--script src="livepipe/scrollbar.js" type="text/javascript"></script-->
        <script src="livepipe/selection.js" type="text/javascript"></script>
        <script src="livepipe/selectmultiple.js" type="text/javascript"></script>
        <script src="livepipe/tabs.js" type="text/javascript"></script>
        <script src="livepipe/textarea.js" type="text/javascript"></script>
        <script src="livepipe/window.js" type="text/javascript"></script>
        <script src="URI.js" type="text/javascript"></script>
        <script src="validation.js" type="text/javascript"></script>
        <script src="input.js" type="text/javascript"></script>
        <script src="array.js" type="text/javascript"></script>
        <script src="merge.js" type="text/javascript"></script>
        <script src="date.js" type="text/javascript"></script> <!-- required by log.js -->
        <script src="log.js" type="text/javascript"></script> <!-- requires prototype.js, date.js -->
        <script src="form.js" type="text/javascript"></script>
        <script src="rivets.js" type="text/javascript"></script>
        <script src="findx.js" type="text/javascript"></script>
        <script src="rivets-adapter-watch-findx.js" type="text/javascript"></script> <!-- requires rivets, watch.js, and findx -->
        <!-- mdv -->
        <!-- this one uses template tags, but cannot get it to work in 5 minutes so switching to rivets
        <script src="Template-instantiation-stable/mdv.js" type="text/javascript"></script> -->

        <script src="base64.js" type="text/javascript"></script>
        <script src="ajax.js" type="text/javascript"></script>
        <script src="atclient.js" type="text/javascript"></script>

        <!-- sample data for testing -->
        <!-- script src="sampledata.js" type="text/javascript"></script -->


        <script type="text/javascript">
            var ws = mtwilson.atag; // local name for the asset tag web service
        </script>

        <script type="text/javascript">
// credit for isNumber (creative commons share alike 3.0) http://stackoverflow.com/questions/18082/validate-numbers-in-javascript-isnumeric/1830844#1830844
function isNumber(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}            
            
            // watch adapter, from https://github.com/mikeric/rivets/wiki/Adapters
            rivets.configure({
                adapter: rivets_watch_findx_adapter,
                prefix: 'bind' // so data binding happens for data-bind-whatever attributes (instead of data-whatever) ; which allows us to use input.js because it uses data-alt.
                /*
                binders: {
                    'alt': function(el,value) { } // do nothing; this allows input.js to continue using data-alt for its default display text. another way to do it would be to use the 'prefix' configuration of rivets like  prefix:'bind' and then use data-bind-whatever instead of just data-whatever in the forms.
                }
                 */
            });
            
            // input like timestamp 1377839054000 or text date format like yyyy-MM-dd, output like:  2013-08-30T05:04:14.000Z
                rivets.formatters.isodate = function(value) {
                        if( isNumber(value) ) {
                            return new Date(value).toISOString();
                        }
                        else {
                            return Date.parse(value).toISOString();
                        }
                    };
                rivets.formatters.date = function(value) {
                        if( isNumber(value) ) {
                            return new Date(value).toString();
                        }
                        else {
                            return Date.parse(value).toString();
                        }
                    };
                    // input any value that evaluates to true/false, output either "yes" or "no" or replace those with your own "yes value" and "no value" for example "Active" and "Inactive" instead of "yes" and "no"
               rivets.formatters.yesno = function(value,yestext,notext) {
                   if( value ) {
                       return yestext ? yestext : "yes";
                   }
                   else {
                       return notext ? notext : "no";
                   }
               };
               // input any hex or base64 value and this will return the value with newlines inserted
               rivets.formatters.wrap = function(text,columns,sep) {
                   var i=0, result="";
                   columns = columns ? parseInt(columns) : 20;
                   sep = sep || " ";
                   log.debug("wrap text: "+text+"  length: "+text.length+"  columns: "+columns);
                   while(i<text.length) { result += text.slice(i,i+columns) + sep; i += columns; }
                   log.debug("wrap result: "+Object.toJSON(result));
                   return result;
               };
               
//                }
            
        </script>

    </head>
    <body>
        
        <!-- wrap starts here -->
        <div class="main" id="mainContainer">
        
            

            <!-- content-wrap starts -->
            <!--div id="content-wrap" class="one-col"  -->	
            <div class="container" id="tagsMainContainer">
                <div class="nagPanel">Asset Tag Management &gt;</div>
                <div id="nameOfPage" class="NameHeader">Create New Tag</div> 

                <div id="main">

                    <div id="tags">
                        <script>
                            function tag_create_form_addValue() {
                                mtwilson.rivets.forms['tag-create-form'].input.mergeInsert({values:[]}); // sets the values to empty array if it's not already defined (applies first time this function is called)
                                var value = (""+$F('tag-create-values')).strip();
                                if( value.empty() ) { return; }
                                //        alert("add value: "+value);
                                log.debug("uh? "+Object.toJSON(mtwilson.rivets.forms['tag-create-form']));
                                mtwilson.rivets.forms['tag-create-form'].input.values.push($F('tag-create-values')); 
                                $('tag-create-values').focus(); 
                                $('tag-create-values').clear();        
                            }
                            function tag_create_form_removeValue(tagValue) {
                                mtwilson.rivets.forms['tag-create-form'].input.values.removeAll(tagValue); 
                                mtwilson.rivets.views['tag-create-form'].sync(); // XXX TODO the watch.js is supposed to detect the change in the array and the rivets-adapter-watach-findx would then call sync... but it doesn' thappen so we have to call sync() ourselves
                            }
                            // called when submitting the form... checks that at least one value was added
                            function tag_create_form_validateValues() {
                                return mtwilson.rivets.forms['tag-create-form'].input.values.length > 0;
                            }
                        </script>
                        <form id="tag-create-form">
                            <ul>
                                <li><label for="tag-create-name">Tag name</label><input type="text" id="tag-create-name" data-bind-value="input.name" name="name" placeholder="Tag name" class="required"/></li>
                                <li><label for="tag-create-oid">Tag OID(optional)</label><input type="text" id="tag-create-oid" data-bind-value="input.oid" name="oid" placeholder="2.5.4.789.1" /></li> 
                                <!-- no longer a required field class="required"  -->
                                <!-- <li><label for="tag-create-description">Tag description</label><input type="text" id="tag-create-description" name="description"/></li> -->
                                <li><label for="tag-create-values">Tag values</label>
                                    <input type="text"  id="tag-create-values" placeholder="Value" class="validate-data" data-validator="tag_create_form_validateValues"/>
                                    <input type="button" value="Add" onclick="tag_create_form_addValue();"/>
                                    <span style="display: none;" class="validation-advice" id="advice-tag-create-values">You must add at least one value.</span>
                                    <ul style="max-width: 600px; margin-left: 0px; padding-left: 0px; list-style: none;">
                                        <li style="display: inline-block; border: 1px solid black; border-radius: 3px; padding-left: 5px; padding-right: 5px; margin: 3px;" data-bind-each-item="input.values"><span data-bind-text="item"></span> <a data-bind-tagValue="item" href="#" style="color: red; font-weight: bold;" onclick="javascript:tag_create_form_removeValue(this.getAttribute('tagValue'));">X</a></li>
                                    </ul>
                                </li>
                                <li><input type="button" value="Save" onclick="ws.createTag(this); return false;"/></li>
                            </ul>
                        </form>


                        <h2>Search Tags</h2>

                        <form id="tag-search-form" action="#" onsubmit="return false;">
                            <ul>
                                <li>
                                    <label for="tag-search-name">Tag name</label>
                                    <select id="tag-search-name-criteria">
                                        <option value="EqualTo">is</option>
                                        <option value="Contains">contains</option>
                                    </select>
                                    <input type="text" id="tag-search-name" name="name" placeholder="Tag name"/>
                                </li>
                                <li>
                                    <label for="tag-search-oid">Tag OID</label>
                                    <select id="tag-search-oid-criteria">
                                        <option value="EqualTo">is</option>
                                        <option value="StartsWith">starts with</option>
                                    </select>
                                    <input type="text" id="tag-search-oid" name="oid" placeholder="Tag OID"/>
                                </li>
                                <li>
                                    <label for="tag-search-value">Tag value</label>
                                    <select id="tag-search-value-criteria">
                                        <option value="EqualTo">is</option>
                                        <option value="Contains">contains</option>
                                    </select>
                                    <input type="text" id="tag-search-value" name="value" placeholder="Tag value"/>
                                </li>
                                <!--
                                <li>
                                    <label for="tag-search-description">Tag description</label>
                                    <select id="tag-search-description-criteria">
                                        <option>contains</option>
                                        <option>is</option>
                                    </select>
                                    <input type="text" id="tag-create-description" name="oid"/>
                                </li>
                                -->
                                <li><input type="button" value="Search..." onclick="ws.searchTags(this); return false;"/></li>
                            </ul>
                        </form>

                        <h2>Browse Tags</h2>

                        <table id="tag-browse-table" class="dataview">
                            <caption>Tags</caption>
                            <thead>
                                <tr>
                                    <th>Tag name</th>
                                    <th>Tag OID</th>
                                    <!-- <th>Description</th> -->
                                    <th>Tag values</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <td colspan="4">
                                        <a href="#">&lt; prev</a> | <a href="#">next 10 &gt;</a>
                                        view&nbsp;<a href="#">5</a>&nbsp;<a href="#">10</a>&nbsp;<a href="#">25</a>&nbsp;<a href="#">50</a>&nbsp;<a href="#">100</a>&nbsp;per page
                                    </td></tr>
                            </tfoot>
                            <tbody>
                                <tr data-bind-each-item="tags">
                                    <td data-bind-text="item.name"></td>
                                    <td data-bind-text="item.oid"></td>
                                    <td style="max-width: 400px;">
                                        <ul style="margin-left: 0px; padding-left: 0px; list-style: none;">
                                            <li style="display: inline-block; list-style-type: inline; border: none; padding: 1px; margin: 3px;" data-bind-each-item="item.values"><span style="text-decoration: underline;" data-bind-text="item"></span></li>
                                        </ul>
                                    </td>
                                    <td><a data-bind-oid="item.oid" data-bind-uuid="item.uuid"  href="#" onclick="javascript:ws.removeTag(this.getAttribute('uuid')); return false;">delete</a></td>
                                </tr>
                            </tbody>
                        </table>


                        <!-- end tags tab  -->
                    </div>

                   <!--
                    <div id="rdf">
                        <h1>Tag Policy Management</h1>


                        <h2>Create New RDF Triple</h2>

                        <form id="rdf-triple-create-form">
                            <ul>
                                <li><label for="rdf-triple-create-subject">Subject</label><input type="text" id="rdf-triple-create-subject" data-bind-value="input.subject" name="subject" placeholder="ID"/></li>
                                <li><label for="rdf-triple-create-predicate">Predicate</label><input type="text" id="rdf-triple-create-predicate" data-bind-value="input.predicate" name="predicate" placeholder="Attribute name"/></li>
                                <li><label for="rdf-triple-create-object">Object</label><input type="text" id="rdf-triple-create-object" data-bind-value="input.object" name="object" placeholder="Attribute value"/></li>
                                <li><input type="button" value="Save" onclick="ws.createRdfTriple(this); return false;"/></li>
                            </ul>
                        </form>

                        <h2>Search RDF Triples</h2>

                        <form id="rdf-triple-search-form" action="#" onsubmit="return false;">
                            <ul>
                                <li>
                                    <label for="rdf-triple-search-subject">Subject (id)</label>
                                    <select id="rdf-triple-search-subject-criteria">
                                        <option value="EqualTo">is</option>
                                        <option value="Contains">contains</option>
                                    </select>
                                    <input type="text" id="rdf-triple-search-subject" name="subject" placeholder="ID"/>
                                </li>
                                <li>
                                    <label for="rdf-triple-search-predicate">Predicate</label>
                                    <select id="rdf-triple-search-predicate-criteria">
                                        <option value="EqualTo">is</option>
                                        <option value="Contains">contains</option>
                                    </select>
                                    <input type="text" id="rdf-triple-search-predicate" name="predicate" placeholder="Attribute name"/>
                                </li>
                                <li>
                                    <label for="rdf-triple-search-object">Object</label>
                                    <select id="rdf-triple-search-object-criteria">
                                        <option value="EqualTo">is</option>
                                        <option value="Contains">contains</option>
                                    </select>
                                    <input type="text" id="rdf-triple-search-object" name="object" placeholder="Attribute value"/>
                                </li>
                               restore comment --
                                <li>
                                    <label for="rdf-triple-search-description">Rdf Triple description</label>
                                    <select id="rdf-triple-search-description-criteria">
                                        <option>contains</option>
                                        <option>is</option>
                                    </select>
                                    <input type="text" id="rdf-triple-create-description" name="predicate"/>
                                </li>
                                --
                                <li><input type="button" value="Search..." onclick="ws.searchRdfTriples(this); return false;"/></li>
                            </ul>
                        </form>

                        <h2>Browse RDF Triples</h2>

                        <table id="rdf-triple-browse-table" class="dataview">
                            <caption>RDF Triples</caption>
                            <thead>
                                <tr>
                                    <th>Subject (id)</th>
                                    <th>Predicate (attribute name)</th>
                                    <th>Object (attribute value)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr> <td colspan="4">
                                        <a href="#">&lt; prev</a> | <a href="#">next 10 &gt;</a>
                                        view&nbsp;<a href="#">5</a>&nbsp;<a href="#">10</a>&nbsp;<a href="#">25</a>&nbsp;<a href="#">50</a>&nbsp;<a href="#">100</a>&nbsp;per page
                                    </td></tr>
                            </tfoot>
                            <tbody>
                                <tr data-bind-each-item="rdfTriples">
                                    <td data-bind-text="item.subject"></td>
                                    <td data-bind-text="item.predicate"></td>
                                    <td data-bind-text="item.object"></td>
                                    <td><a data-bind-uuid="item.uuid" href="#" onclick="javascript:ws.removeRdfTriple(this.getAttribute('uuid')); return false;">delete</a></td>
                                </tr>
                            </tbody>
                        </table>
                        
                    </div>       
                   -->
                    
                </div>

                <!-- content-wrap ends-->	
            </div>

           
            <!-- wrap ends here -->
        </div>

        <!-- configure javascript logging -->								
        <script>
            log.attach("logwindow");
        </script>

        <!-- script must be at the end of the markup so it can reference any element -->
        <script>
            // this section initializes the user interface   
            var navTabs = new Control.Tabs('navtabs', {
                activeClassName: 'current',
                setClassOnContainer: true,
                afterChange: function(new_container) {
                    if(new_container.id == 'tags') {
                        //                        onUpdateVoterIssues();
                    }
                    if(new_container.id == 'certificates') {
                        //                        onDisplayTally();
                    }
                }
            });
            
            
            var anchorValue;
            var url = document.location;
            var strippedUrl = url.toString().split("#");
            if(strippedUrl.length > 1)
            anchorvalue = strippedUrl[1];
            navTabs.setActiveTab(anchorvalue);
            
            //navTabs.setActiveTab('tags');
            //navTabs.setActiveTab('certificates');  // XXX for debugging only; normally start with 'tags''
            //$('ajaxstatus').hide();
            $('certificate-provision-form').hide();
        </script>


        <script>
            //log.debug("adapter: "+rivets_watch_findx_adapter);
            //rivets-test
            //var taglist = [ {name:"tag1",oid:"1.1"}, {name:"tag2",oid:"2.2" } ];
            //var taglist = [ "hello", "world" ];
            //var taglist = [ [{name:"hello"}, {name:"world"}] ];
            //var myview = rivets.bind(document.getElementById('rivets-test'), { tags: [ {item:"hello"},{item:"world"}] }); // instead of sampledata.tags
            // *** these were enabled ***
            var alertView, tagview, rdfview, selectionview, tagviewCertificateRequests, certificateView /*, appview */, configurationView;
            //
            //taglist.push("test");
            //myview.build();
            //mybindings.update({filter: mytags});
            //sampledata.tags.push({"name":"new tag","oid":"1.2.3.4","values":["hello","world"]});
            // make sure all dom elements are loaded before initializing the web layer
            document.observe('dom:loaded', function() {
                ws.initialize({
                    options: {
                        baseurl: 'http://localhost:8080'
                    }
                    //views: { 'tags': tagview, 'rdf-triples': rdfview }
    //                data: sampledata, // optional: if not provided will start empty and then we can load it from server
    /*
                    view: { 'update': function(data) {
                            var i = mtwilson.rivets.views.length; // until they respond we don't know what these tags are;  TODO if user changes here make sure yo uupdate config in database
                            while(i--) {
                                mtwilson.rivets.views[i].update(data);
                            }
    // //                     appview.update(data); 
    //                        tagview.update(data);
    //                        rdfview.update(data);
    //                        selectionview.update(data);
    //  //                      tagviewCertificateRequests.update(data);
    //                        certificateView.update(data); 
    //                        configurationView.update(data);
                        },
                        'sync': function() {
                            var i = mtwilson.rivets.views.length; // until they respond we don't know what these tags are;  TODO if user changes here make sure yo uupdate config in database
                            while(i--) {
                                mtwilson.rivets.views[i].sync();
                            }
    ////                        appview.sync(); 
    //                        tagview.sync();
    //                        rdfview.sync();
    //                        selectionview.sync();
    // //                       tagviewCertificateRequests.sync();
    //                        certificateView.sync(); 
    //                        configurationView.sync();
                        }
                    }*/
                });
                log.debug("done initializing ws");
            });
            
            //alertView = rivets.bind(document.getElementById('notifications'), ws.data);

//            appview = rivets.bind(document.getElementById('main'), ws.data); 
//            tagview = rivets.bind(document.getElementById('tag-browse-table'), ws.data); 
//            rdfview = rivets.bind(document.getElementById('rdf-triple-browse-table'), ws.data); 
//            selectionview = rivets.bind(document.getElementById('selection-browse-table'), ws.data); 
////            tagviewCertificateRequests = rivets.bind(document.getElementById('certificate-request-create-form'), ws.data); 
//            certificateView = rivets.bind(document.getElementById('certificate-browse-table'), ws.data); 
//            configurationView = rivets.bind(document.getElementById('config-form'), ws.data.currentConfiguration); 

            // wait for the webservice library to initialize, then populate the UI with some data from the server. 
            // XXX TODO create special 'views' resources on the  server that can provide all the info
            // we need in one response. so for example the default search for tags, triples, and selections, as well
            // as main configuration and cacerts... all would be defined in one 'view' that would be merged into
            // mtwilson.data. 
            document.observe('mtwilson:ready', function() {
                log.debug("after init (mtwilson:ready), data: "+Object.toJSON(ws.data));
                ws.searchTags('tag-search-form');
                // ws.searchRdfTriples('rdf-triple-search-form');
                ws.searchSelections('selection-search-form');
                ws.searchConfigurations('configuration-search-form');
                ws.loadCaCerts();
//                ws.retrieveMainConfiguration();
            
            });
        </script>

    </body>
</html>
